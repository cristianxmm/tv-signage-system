<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pantalla Corporativa</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
    
    <style>
        /* --- GENERAL --- */
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', Arial, sans-serif; }
        .view-section { display: none; width: 100vw; height: 100vh; position: relative; }

        /* --- GALER√çA (SWIPER) --- */
        .swiper { width: 100%; height: 100%; }
        .swiper-slide {
            background: #000;
            display: flex;
            justify-content: center; /* Centrado Horizontal */
            align-items: center;     /* Centrado Vertical */
        }
        .swiper-slide img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; /* Ajusta la imagen sin recortarla */
            display: block;
        }

        /* --- ESTILO EXCEL (CLARO) --- */
        #vista-excel {
            background-color: #f0f0f0; /* Fondo gris claro de app */
            display: flex;
            flex-direction: column;
        }

        /* Contenedor de la tabla con scroll */
        #excel-container {
            flex: 1; /* Ocupa todo el espacio disponible */
            overflow: auto;
            background: #fff;
            padding: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 1.2rem;
            color: #000;
        }

        th {
            background-color: #e6e6e6; /* Gris encabezado */
            border: 1px solid #999;
            padding: 10px;
            text-align: left;
            font-weight: bold;
        }

        td {
            border: 1px solid #ccc; /* Bordes celdas */
            padding: 8px 12px;
        }

        tr:nth-child(even) { background-color: #f9f9f9; } /* Filas alternas */

        /* --- PESTA√ëAS (TABS) INFERIORES --- */
        #excel-tabs {
            height: 50px;
            background: #217346; /* Verde Excel */
            display: flex;
            align-items: flex-end;
            padding-left: 10px;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.2);
        }

        .tab-btn {
            padding: 10px 20px;
            background: #1a5c38;
            color: #fff;
            border: none;
            margin-right: 2px;
            cursor: pointer;
            font-size: 1rem;
            border-radius: 5px 5px 0 0;
            opacity: 0.8;
        }

        .tab-btn.active {
            background: #fff;
            color: #217346;
            font-weight: bold;
            opacity: 1;
        }

        /* --- VIDEO --- */
        #vista-video { background: #000; display: flex; align-items: center; justify-content: center; }
        video { width: 100%; height: 100%; object-fit: contain; }

        #id-pantalla { position: absolute; bottom: 10px; right: 10px; color: rgba(255,255,255,0.5); z-index: 999; }
    </style>
</head>
<body>

    <div id="vista-galeria" class="view-section">
        <div class="swiper mySwiper">
            <div class="swiper-wrapper" id="galeria-contenido"></div>
            <div class="swiper-button-next"></div>
            <div class="swiper-button-prev"></div>
            <div class="swiper-pagination"></div>
        </div>
    </div>

    <div id="vista-excel" class="view-section" style="display: none;">
        <div id="excel-container">
            <div id="tabla-render"></div> </div>
        <div id="excel-tabs"></div> </div>

    <div id="vista-video" class="view-section">
        <video id="video-display" autoplay muted loop playsinline></video>
    </div>

    <div id="vista-imagen" class="view-section" style="display:flex; justify-content:center; align-items:center; background:black;">
        <img id="img-display" src="" style="max-width:100%; max-height:100%; object-fit:contain;">
    </div>

    <div id="id-pantalla">ID: ...</div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    
    <script>
        const socket = io();
        const params = new URLSearchParams(window.location.search);
        const myId = params.get('id') || 'general';
        document.getElementById('id-pantalla').innerText = `ID: ${myId}`;
        socket.emit('join', myId);

        let swiper;
        let hojasExcelActuales = []; // Para guardar los datos del excel en memoria

        socket.on('contentUpdate', (payload) => {
            if(payload.target !== 'all' && payload.target !== myId) return;
            ocultarTodo();

            // --- GALER√çA (MANUAL) ---
            if (payload.type === 'gallery') {
                const wrapper = document.getElementById('galeria-contenido');
                wrapper.innerHTML = '';
                payload.urls.forEach(url => {
                    wrapper.innerHTML += `<div class="swiper-slide"><img src="${url}"></div>`;
                });
                document.getElementById('vista-galeria').style.display = 'block';

                if (swiper) swiper.destroy(true, true);
                
                swiper = new Swiper(".mySwiper", {
                    spaceBetween: 0,
                    effect: "fade", // Bonito efecto de desvanecer
                    navigation: { nextEl: ".swiper-button-next", prevEl: ".swiper-button-prev" },
                    pagination: { el: ".swiper-pagination", clickable: true },
                    autoplay: false, // üõë AQU√ç SE DESACTIVA EL AUTO-CAMBIO
                    loop: true
                });
            }

            // --- EXCEL (MULTI HOJAS) ---
            else if (payload.type === 'excel_full') {
                hojasExcelActuales = payload.hojas; // Guardamos datos
                renderExcelTabs(); // Dibujamos pesta√±as
                cambiarHoja(0); // Mostramos la primera hoja por defecto
                document.getElementById('vista-excel').style.display = 'flex'; // Usamos flex para el layout
            }

            // --- VIDEO ---
            else if (payload.type === 'video') {
                const v = document.getElementById('video-display');
                v.src = payload.url;
                document.getElementById('vista-video').style.display = 'flex';
                v.play().catch(e => console.log("Click para reproducir"));
            }

            // --- IMAGEN √öNICA ---
            else if (payload.type === 'image') {
                document.getElementById('img-display').src = payload.url;
                document.getElementById('vista-imagen').style.display = 'flex';
            }
        });

        function ocultarTodo() {
            document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');
            document.getElementById('video-display').pause();
        }

        // --- L√ìGICA DE EXCEL ---
        function renderExcelTabs() {
            const container = document.getElementById('excel-tabs');
            container.innerHTML = '';
            
            hojasExcelActuales.forEach((hoja, index) => {
                const btn = document.createElement('button');
                btn.className = 'tab-btn';
                btn.innerText = hoja.nombre;
                btn.onclick = () => cambiarHoja(index);
                container.appendChild(btn);
            });
        }

        function cambiarHoja(index) {
            // 1. Actualizar estilo de pesta√±as
            document.querySelectorAll('.tab-btn').forEach((b, i) => {
                b.classList.toggle('active', i === index);
            });

            // 2. Renderizar tabla
            const data = hojasExcelActuales[index].data;
            const container = document.getElementById('tabla-render');
            
            if(!data || data.length === 0) {
                container.innerHTML = '<h3>Hoja vac√≠a</h3>';
                return;
            }

            let html = '<table><thead><tr>';
            const headers = Object.keys(data[0]);
            
            headers.forEach(h => html += `<th>${h}</th>`);
            html += '</tr></thead><tbody>';
            
            data.forEach(row => {
                html += '<tr>';
                headers.forEach(h => html += `<td>${row[h] || ''}</td>`); // Manejo de celdas vac√≠as
                html += '</tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

    </script>
</body>
</html>
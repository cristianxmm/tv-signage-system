<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pantalla TV</title>
    <style>
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        .view-section {
            display: none; 
            width: 100%;
            height: 100%;
        }

        /* --- TABLA --- */
        #vista-tabla { padding: 20px; box-sizing: border-box; overflow: auto; text-align: center; }
        table {
            width: 95%;
            margin: 20px auto;
            border-collapse: collapse;
            font-size: 2em; 
            background-color: #1a1a1a;
        }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #444; }
        th { background-color: #333; color: #00d2ff; }
        tr:nth-child(even) { background-color: #222; }

        /* --- MULTIMEDIA --- */
        #vista-imagen, #vista-video {
            display: none;
            align-items: center;
            justify-content: center;
            background: #000;
            width: 100vw;
            height: 100vh;
        }

        img {
            max-width: 100%;
            max-height: 100vh;
            object-fit: contain; 
        }

        /* AJUSTE PARA VIDEO FULLSCREEN */
        video {
            width: 100%;
            height: 100%;
            object-fit: contain; /* Usa 'cover' si quieres que llene todo sin bordes negros, pero cortará imagen */
        }

        #id-pantalla {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 14px;
            color: rgba(255,255,255,0.4);
            background: rgba(0,0,0,0.6);
            padding: 4px 8px;
            border-radius: 4px;
            z-index: 1000;
        }
    </style>
</head>
<body>

    <div id="vista-tabla" class="view-section">
        <h1 style="color: #00d2ff; margin-top:0;">Reporte Actualizado</h1>
        <div id="tabla-contenido"></div>
    </div>

    <div id="vista-imagen" class="view-section">
        <img id="img-display" src="" alt="Imagen">
    </div>

    <div id="vista-video" class="view-section">
        <video id="video-display" autoplay muted loop playsinline>
            <source src="" type="video/mp4">
        </video>
    </div>

    <div id="vista-espera" class="view-section" style="display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <h1>Esperando contenido...</h1>
    </div>

    <div id="id-pantalla">Conectando...</div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const params = new URLSearchParams(window.location.search);
        const myId = params.get('id') || 'general';
        
        document.getElementById('id-pantalla').innerText = `ID: ${myId}`;
        socket.emit('join', myId);

        // --- LÓGICA DE VIDEO ROBUSTA ---
        const videoElement = document.getElementById('video-display');

        // Seguro de vida: Si el video termina, fuérzalo a reproducir de nuevo
        videoElement.addEventListener('ended', () => {
            videoElement.currentTime = 0;
            videoElement.play();
        });

        socket.on('contentUpdate', (payload) => {
            if(payload.target !== 'all' && payload.target !== myId) return;

            console.log('Recibido:', payload.type);
            ocultarTodo();

            if (payload.type === 'table') {
                renderTable(payload.data);
                document.getElementById('vista-tabla').style.display = 'block';
            } 
            else if (payload.type === 'image') {
                document.getElementById('img-display').src = payload.url;
                document.getElementById('vista-imagen').style.display = 'flex';
            }
            else if (payload.type === 'video') {
                videoElement.src = payload.url;
                document.getElementById('vista-video').style.display = 'flex';
                
                // Promesa para asegurar reproducción
                var playPromise = videoElement.play();
                if (playPromise !== undefined) {
                    playPromise.then(_ => {
                        // Reproducción automática comenzó
                    })
                    .catch(error => {
                        console.log("El navegador bloqueó el autoplay. Asegúrate de interactuar con la página primero.");
                    });
                }
            }
        });

        function ocultarTodo() {
            document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');
            // Pausar video anterior para liberar memoria
            videoElement.pause();
        }

        function renderTable(data) {
            if(!data || data.length === 0) return;
            const contenedor = document.getElementById('tabla-contenido');
            let html = '<table><thead><tr>';
            const headers = Object.keys(data[0]);
            headers.forEach(h => html += `<th>${h}</th>`);
            html += '</tr></thead><tbody>';
            data.forEach(row => {
                html += '<tr>';
                headers.forEach(h => html += `<td>${row[h]}</td>`);
                html += '</tr>';
            });
            html += '</tbody></table>';
            contenedor.innerHTML = html;
        }

        document.getElementById('vista-espera').style.display = 'flex';
    </script>
</body>
</html>